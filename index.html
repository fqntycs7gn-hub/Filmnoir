<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FilmNoir â€“ Láº¥y Sá»‘ Thá»© Tá»±</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Be+Vietnam+Pro:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --beige: #f5efe6;
    --beige-dark: #e8ddd0;
    --wine: #6b2737;
    --wine-dark: #4a1a25;
    --wine-light: #8b3a4e;
    --black: #1a1410;
    --gray: #7a6e65;
    --cream: #faf7f2;
    --gold: #c9a96e;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:var(--beige);
    color:var(--black);
    font-family:'Be Vietnam Pro',sans-serif;
    min-height:100vh;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23f5efe6'/%3E%3Ccircle cx='1' cy='1' r='0.5' fill='%23d4c4b0' opacity='0.4'/%3E%3C/svg%3E");
  }
  body::before {
    content:''; position:fixed; inset:12px;
    border:1px solid var(--wine); opacity:0.2;
    pointer-events:none; z-index:9999;
  }
  header { text-align:center; padding:48px 24px 32px; border-bottom:1px solid var(--wine); }
  .logo-ornament {
    font-family:'Space Mono',monospace; font-size:10px; letter-spacing:6px;
    color:var(--wine); opacity:0.6; margin-bottom:12px; display:block;
  }
  h1.brand {
    font-family:'Libre Baskerville',serif; font-size:clamp(2.5rem,8vw,5rem);
    font-weight:700; color:var(--wine); letter-spacing:0.08em; line-height:1; text-transform:uppercase;
  }
  .brand-sub {
    font-family:'Be Vietnam Pro',sans-serif; font-style:italic; font-size:1.1rem;
    color:var(--gray); letter-spacing:0.15em; margin-top:6px;
  }
  nav.tabs {
    display:flex; justify-content:center; margin:32px 24px 0;
    border-bottom:2px solid var(--wine); flex-wrap:wrap;
  }
  nav.tabs button {
    font-family:'Space Mono',monospace; font-size:11px; letter-spacing:3px; text-transform:uppercase;
    padding:14px 24px; background:transparent; border:none; border-bottom:3px solid transparent;
    margin-bottom:-2px; cursor:pointer; color:var(--gray); transition:all .25s;
  }
  nav.tabs button.active {
    color:var(--wine); border-bottom-color:var(--wine);
    background:linear-gradient(to top,rgba(107,39,55,0.06),transparent);
  }
  nav.tabs button:hover:not(.active) { color:var(--wine-light); }
  main { max-width:860px; margin:0 auto; padding:40px 24px 80px; }

.room-tabs { display:flex; gap:0; margin-bottom:28px; border-bottom:1px solid var(â€“beige-dark); flex-wrap:wrap; }
.room-tabs button {
font-family:â€˜Space Monoâ€™,monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase;
padding:10px 20px; background:transparent; border:none; border-bottom:2px solid transparent;
margin-bottom:-1px; cursor:pointer; color:var(â€“gray); transition:all .2s;
}
.room-tabs button.active { color:var(â€“wine); border-bottom-color:var(â€“wine); }

.card {
background:var(â€“cream); border:1px solid var(â€“beige-dark); padding:36px 40px;
position:relative; margin-bottom:24px; box-shadow:4px 4px 0 rgba(107,39,55,0.08);
}
.card::before {
content:â€™â€™; position:absolute; top:6px; left:6px; right:-6px; bottom:-6px;
border:1px solid rgba(107,39,55,0.12); z-index:-1;
}
.card-title {
font-family:â€˜Libre Baskervilleâ€™,serif; font-size:1.4rem; font-weight:700;
color:var(â€“wine); margin-bottom:24px; display:flex; align-items:center; gap:12px;
}
.card-title::before { content:â€™â€™; display:inline-block; width:28px; height:1px; background:var(â€“wine); }

.field { margin-bottom:20px; }
label {
display:block; font-family:â€˜Space Monoâ€™,monospace; font-size:10px; letter-spacing:3px;
text-transform:uppercase; color:var(â€“gray); margin-bottom:8px;
}
input, select {
width:100%; padding:12px 16px; font-family:â€˜Be Vietnam Proâ€™,sans-serif; font-size:1.1rem;
background:var(â€“beige); border:1px solid var(â€“beige-dark); color:var(â€“black);
outline:none; transition:border-color .2s; -webkit-appearance:none; appearance:none;
}
input:focus, select:focus { border-color:var(â€“wine); }
.select-wrap { position:relative; }
.select-wrap::after {
content:â€˜â–¾â€™; position:absolute; right:14px; top:50%; transform:translateY(-50%);
color:var(â€“wine); pointer-events:none; font-size:14px;
}

.btn {
font-family:â€˜Space Monoâ€™,monospace; font-size:11px; letter-spacing:3px;
text-transform:uppercase; padding:14px 32px; border:none; cursor:pointer; transition:all .2s;
}
.btn-primary { background:var(â€“wine); color:var(â€“beige); width:100%; margin-top:8px; }
.btn-primary:hover { background:var(â€“wine-dark); }
.btn-primary:active { transform:translateY(1px); }
.btn-primary:disabled { opacity:0.5; cursor:not-allowed; }
.btn-cancel { background:transparent; color:var(â€“wine); border:1px solid var(â€“wine); padding:8px 20px; font-size:10px; }
.btn-cancel:hover { background:var(â€“wine); color:var(â€“beige); }

.ticket {
background:var(â€“cream); border:2px solid var(â€“wine); padding:40px;
text-align:center; position:relative; overflow:hidden;
}
.ticket::before, .ticket::after {
content:â€™â€™; position:absolute; left:50%; transform:translateX(-50%);
width:24px; height:12px; background:var(â€“beige); border:2px solid var(â€“wine);
}
.ticket::before { top:-2px; border-top:none; border-radius:0 0 12px 12px; }
.ticket::after { bottom:-2px; border-bottom:none; border-radius:12px 12px 0 0; }
.ticket-num { font-family:â€˜Libre Baskervilleâ€™,serif; font-size:5rem; font-weight:700; color:var(â€“wine); line-height:1; }
.ticket-label { font-family:â€˜Space Monoâ€™,monospace; font-size:10px; letter-spacing:4px; text-transform:uppercase; color:var(â€“gray); margin-bottom:8px; }
.ticket-name { font-style:italic; font-size:1.3rem; color:var(â€“black); margin-top:12px; }
.ticket-room { font-family:â€˜Space Monoâ€™,monospace; font-size:10px; letter-spacing:3px; color:var(â€“wine); margin-top:8px; }
.ticket-divider { border:none; border-top:1px dashed var(â€“wine); opacity:.4; margin:20px 0; }

.notif {
background:linear-gradient(135deg,var(â€“wine-dark),var(â€“wine));
color:var(â€“beige); padding:16px 20px; margin-top:16px;
font-style:italic; font-size:1rem; line-height:1.5;
}

.rooms-overview { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:28px; }
.room-overview-card {
background:var(â€“cream); border:1px solid var(â€“beige-dark); padding:20px 16px;
text-align:center; cursor:pointer; transition:border-color .2s, box-shadow .2s;
}
.room-overview-card:hover { border-color:var(â€“wine); box-shadow:3px 3px 0 rgba(107,39,55,0.12); }
.room-overview-card.selected { border-color:var(â€“wine); background:linear-gradient(to bottom,rgba(107,39,55,0.05),var(â€“cream)); }
.room-overview-card .room-label { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:3px; color:var(â€“gray); margin-bottom:4px; }
.room-overview-card .room-name { font-family:â€˜Libre Baskervilleâ€™,serif; font-size:1rem; color:var(â€“wine); font-weight:700; margin-bottom:12px; font-style:italic; }
.room-overview-card .room-count { font-family:â€˜Libre Baskervilleâ€™,serif; font-size:2.4rem; font-weight:700; color:var(â€“wine); line-height:1; }
.room-overview-card .room-sub { font-family:â€˜Space Monoâ€™,monospace; font-size:8px; letter-spacing:2px; color:var(â€“gray); margin-top:4px; }
.room-overview-card .room-serving { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:1px; color:var(â€“gray); margin-top:10px; padding-top:10px; border-top:1px solid var(â€“beige-dark); }

.queue-item { display:flex; align-items:center; gap:16px; padding:16px 20px; background:var(â€“cream); border:1px solid var(â€“beige-dark); margin-bottom:8px; }
.queue-item.current { border-color:var(â€“wine); background:linear-gradient(to right,rgba(107,39,55,0.06),var(â€“cream)); }
.queue-item.almost { border-color:var(â€“gold); }
.q-num { font-family:â€˜Libre Baskervilleâ€™,serif; font-size:1.6rem; font-weight:700; color:var(â€“wine); min-width:48px; text-align:center; }
.q-info { flex:1; }
.q-name { font-size:1.1rem; }
.q-detail { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:2px; color:var(â€“gray); margin-top:3px; }
.badge { font-family:â€˜Space Monoâ€™,monospace; font-size:8px; letter-spacing:2px; text-transform:uppercase; padding:3px 10px; border:1px solid; }
.badge-now { color:var(â€“wine); border-color:var(â€“wine); }
.badge-soon { color:#a07020; border-color:var(â€“gold); }

.msg { padding:14px 20px; margin-bottom:20px; font-size:1rem; font-style:italic; }
.msg-success { background:rgba(107,39,55,0.08); border-left:3px solid var(â€“wine); }
.msg-error { background:rgba(180,60,60,0.08); border-left:3px solid #b43c3c; color:#7a1515; }

.qr-wrap { display:flex; flex-direction:column; align-items:center; gap:12px; margin:20px 0; }
.qr-hint { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:3px; text-transform:uppercase; color:var(â€“gray); }

.ornament { text-align:center; color:var(â€“wine); opacity:.3; font-size:18px; letter-spacing:8px; margin:8px 0 24px; }

.admin-queue-item { display:flex; align-items:center; gap:12px; padding:12px 16px; border:1px solid var(â€“beige-dark); margin-bottom:6px; background:var(â€“cream); }
.btn-serve { background:var(â€“wine); color:var(â€“beige); border:none; font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:2px; padding:6px 14px; cursor:pointer; white-space:nowrap; }
.btn-serve:hover { background:var(â€“wine-dark); }
.btn-remove { background:transparent; color:#b43c3c; border:1px solid #b43c3c; font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:2px; padding:6px 14px; cursor:pointer; white-space:nowrap; }
.btn-remove:hover { background:#b43c3c; color:white; }

/* Loading */
.loading-bar {
position:fixed; top:0; left:0; height:2px; background:var(â€“wine);
transition:width .3s; z-index:99999;
}

/* Connection status */
.conn-status {
position:fixed; bottom:20px; right:20px;
font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:2px;
padding:6px 12px; border:1px solid; z-index:9998;
transition:all .3s;
}
.conn-online { color:var(â€“wine); border-color:var(â€“wine); background:var(â€“cream); }
.conn-offline { color:#b43c3c; border-color:#b43c3c; background:#fff5f5; }

/* Modal */
.modal-overlay {
display:none; position:fixed; inset:0;
background:rgba(26,20,16,0.7); z-index:10000;
justify-content:center; align-items:center; backdrop-filter:blur(3px);
}
.modal-box {
background:var(â€“cream); border:2px solid var(â€“wine); padding:48px 40px;
width:min(420px,90vw); text-align:center; position:relative;
box-shadow:8px 8px 0 rgba(107,39,55,0.15); animation:fadeIn 0.3s ease;
}
.modal-box::before {
content:â€™â€™; position:absolute; top:6px; left:6px; right:-6px; bottom:-6px;
border:1px solid rgba(107,39,55,0.2); z-index:-1;
}
.modal-lock { font-size:2rem; margin-bottom:12px; }
.modal-title { font-family:â€˜Libre Baskervilleâ€™,serif; font-size:1.5rem; font-weight:700; color:var(â€“wine); margin-bottom:6px; }
.modal-sub { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:3px; text-transform:uppercase; color:var(â€“gray); margin-bottom:28px; }
.modal-input {
width:100%; padding:14px 18px; font-family:â€˜Be Vietnam Proâ€™,sans-serif; font-size:1.2rem;
background:var(â€“beige); border:1px solid var(â€“beige-dark); color:var(â€“black);
outline:none; text-align:center; letter-spacing:4px; margin-bottom:8px;
}
.modal-input:focus { border-color:var(â€“wine); }
.modal-error { font-family:â€˜Space Monoâ€™,monospace; font-size:10px; letter-spacing:2px; color:#b43c3c; margin-bottom:12px; display:none; }
.modal-btn {
width:100%; padding:14px; background:var(â€“wine); color:var(â€“beige); border:none;
font-family:â€˜Space Monoâ€™,monospace; font-size:11px; letter-spacing:3px; text-transform:uppercase;
cursor:pointer; margin-bottom:12px; transition:background .2s;
}
.modal-btn:hover { background:var(â€“wine-dark); }
.modal-close { font-family:â€˜Space Monoâ€™,monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(â€“gray); background:none; border:none; cursor:pointer; text-decoration:underline; }
.modal-close:hover { color:var(â€“wine); }

.fade-in { animation:fadeIn 0.4s ease forwards; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

@media(max-width:600px) {
.rooms-overview { grid-template-columns:1fr; }
.card { padding:24px 20px; }
.room-tabs button { padding:10px 14px; font-size:9px; }
}
</style>

</head>
<body>

<div class="loading-bar" id="loading-bar" style="width:0%"></div>
<div class="conn-status conn-online" id="conn-status">â— ONLINE</div>

<header>
  <span class="logo-ornament">âœ¦ &nbsp; photobooth studio &nbsp; âœ¦</span>
  <h1 class="brand">FilmNoir</h1>
  <p class="brand-sub">HÃ ng chá» Â· Queue Management</p>
</header>

<nav class="tabs">
  <button class="active" onclick="switchTab('book')">Äáº·t Lá»‹ch</button>
  <button onclick="switchTab('check')">Kiá»ƒm Tra Sá»‘</button>
  <button onclick="switchTab('queue')">HÃ ng Chá»</button>
  <button onclick="switchTab('admin')">Quáº£n LÃ½</button>
</nav>

<main>

  <!-- BOOK -->

  <div id="tab-book" class="tab-content">
    <div class="ornament">â€” â—ˆ â€”</div>
    <div id="msg-book"></div>
    <div class="card fade-in" id="form-card">
      <div class="card-title">ÄÄƒng KÃ½ LÆ°á»£t Chá»¥p</div>
      <div class="field">
        <label>Há» &amp; TÃªn</label>
        <input type="text" id="inp-name" placeholder="Nguyá»…n VÄƒn A"/>
      </div>
      <div class="field">
        <label>Sá»‘ Äiá»‡n Thoáº¡i</label>
        <input type="tel" id="inp-phone" placeholder="0901 234 567"/>
      </div>
      <div class="field">
        <label>Chá»n PhÃ²ng Chá»¥p</label>
        <div class="select-wrap">
          <select id="inp-room">
            <option value="">â€” Chá»n phÃ²ng â€”</option>
            <option value="room1">PhÃ²ng 1 â€“ Star Light</option>
            <option value="room2">PhÃ²ng 2 â€“ Heart Garden</option>
            <option value="room3">PhÃ²ng 3 â€“ Red Cherry</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="btn-book" onclick="bookQueue()">âœ¦ Láº¥y Sá»‘ Thá»© Tá»±</button>
    </div>
    <div id="ticket-wrap" style="display:none;" class="fade-in">
      <div class="ticket">
        <div class="ticket-label">sá»‘ thá»© tá»± cá»§a báº¡n</div>
        <div class="ticket-num" id="ticket-num">â€”</div>
        <hr class="ticket-divider"/>
        <div class="ticket-name" id="ticket-name">â€”</div>
        <div class="ticket-room" id="ticket-room">â€”</div>
        <hr class="ticket-divider"/>
        <div class="qr-wrap">
          <canvas id="qr-canvas" width="140" height="140"></canvas>
          <span class="qr-hint">QuÃ©t Ä‘á»ƒ kiá»ƒm tra lÆ°á»£t</span>
        </div>
        <div id="ticket-notif"></div>
      </div>
      <br/>
      <button class="btn btn-cancel" onclick="resetForm()">â† ÄÄƒng KÃ½ ThÃªm</button>
    </div>
  </div>

  <!-- CHECK -->

  <div id="tab-check" class="tab-content" style="display:none;">
    <div class="ornament">â€” â—ˆ â€”</div>
    <div class="card fade-in">
      <div class="card-title">Kiá»ƒm Tra Sá»‘ Thá»© Tá»±</div>
      <div id="msg-check"></div>
      <div class="field">
        <label>Sá»‘ Äiá»‡n Thoáº¡i</label>
        <input type="tel" id="chk-phone" placeholder="Nháº­p sá»‘ Ä‘Ã£ Ä‘Äƒng kÃ½"/>
      </div>
      <button class="btn btn-primary" onclick="checkQueue()">Kiá»ƒm Tra</button>
      <div id="check-result" style="margin-top:24px;display:none;" class="fade-in">
        <div class="ticket">
          <div class="ticket-label">sá»‘ thá»© tá»± cá»§a báº¡n</div>
          <div class="ticket-num" id="chk-num">â€”</div>
          <hr class="ticket-divider"/>
          <div class="ticket-name" id="chk-name">â€”</div>
          <div class="ticket-room" id="chk-room">â€”</div>
          <hr class="ticket-divider"/>
          <div style="font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--gray);">
            Sá»‘ Ä‘ang phá»¥c vá»¥: <span id="chk-current" style="color:var(--wine);font-weight:bold;"></span>
          </div>
          <div style="font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--gray);margin-top:4px;">
            Báº¡n cÃ²n chá»: <span id="chk-wait" style="color:var(--wine);font-weight:bold;"></span> lÆ°á»£t
          </div>
          <div id="chk-notif"></div>
        </div>
        <br/>
        <button class="btn btn-cancel" onclick="cancelFromCheck()">âœ• Huá»· LÆ°á»£t Cá»§a TÃ´i</button>
      </div>
    </div>
  </div>

  <!-- QUEUE -->

  <div id="tab-queue" class="tab-content" style="display:none;">
    <div class="ornament">â€” â—ˆ â€”</div>
    <div class="rooms-overview" id="queue-overview"></div>
    <div class="room-tabs" id="queue-room-tabs">
      <button class="active" onclick="switchRoomQueue(0)">PhÃ²ng 1 â€“ Star Light</button>
      <button onclick="switchRoomQueue(1)">PhÃ²ng 2 â€“ Heart Garden</button>
      <button onclick="switchRoomQueue(2)">PhÃ²ng 3 â€“ Red Cherry</button>
    </div>
    <div id="queue-room-detail"></div>
  </div>

  <!-- ADMIN -->

  <div id="tab-admin" class="tab-content" style="display:none;">
    <div class="ornament">â€” â—ˆ â€”</div>
    <div class="rooms-overview" id="admin-overview"></div>
    <div class="room-tabs" id="admin-room-tabs">
      <button class="active" onclick="switchRoomAdmin(0)">PhÃ²ng 1 â€“ Star Light</button>
      <button onclick="switchRoomAdmin(1)">PhÃ²ng 2 â€“ Heart Garden</button>
      <button onclick="switchRoomAdmin(2)">PhÃ²ng 3 â€“ Red Cherry</button>
    </div>
    <div class="card fade-in">
      <div class="card-title" id="admin-room-title">â€”</div>
      <div id="msg-admin"></div>
      <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
        <button class="btn btn-primary" style="width:auto;" onclick="serveNext()">â†’ Phá»¥c Vá»¥ Sá»‘ Tiáº¿p Theo</button>
        <button class="btn btn-cancel" onclick="resetRoom()">â†º Reset PhÃ²ng NÃ y</button>
      </div>
      <div id="admin-queue-list"></div>
    </div>
  </div>

  <!-- MODAL -->

  <div class="modal-overlay" id="admin-modal" onclick="if(event.target===this)closeAdminModal()">
    <div class="modal-box">
      <div class="modal-lock">ğŸ”’</div>
      <div class="modal-title">Khu Vá»±c Quáº£n LÃ½</div>
      <div class="modal-sub">Chá»‰ dÃ nh cho nhÃ¢n viÃªn FilmNoir</div>
      <input class="modal-input" type="password" id="modal-pw-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        onkeydown="if(event.key==='Enter')submitAdminPw()"/>
      <div class="modal-error" id="modal-pw-error">Máº­t kháº©u khÃ´ng Ä‘Ãºng. Vui lÃ²ng thá»­ láº¡i.</div>
      <button class="modal-btn" onclick="submitAdminPw()">XÃ¡c Nháº­n</button>
      <button class="modal-close" onclick="closeAdminModal()">Huá»·</button>
    </div>
  </div>

</main>

<!-- Firebase -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, get, update, remove, runTransaction, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC83UvWv5fiLixf1Bv630DtY7rgZfjsj4g",
  authDomain: "filmnoir-5fc58.firebaseapp.com",
  databaseURL: "https://filmnoir-5fc58-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "filmnoir-5fc58",
  storageBucket: "filmnoir-5fc58.firebasestorage.app",
  messagingSenderId: "530896508346",
  appId: "1:530896508346:web:7710bde5281bc86ea53983"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROOMS = [
  { key:'room1', label:'PhÃ²ng 1', name:'Star Light' },
  { key:'room2', label:'PhÃ²ng 2', name:'Heart Garden' },
  { key:'room3', label:'PhÃ²ng 3', name:'Red Cherry' },
];

const QR_API = t => `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(t)}&bgcolor=faf7f2&color=6b2737&format=png&margin=2`;

// â”€â”€â”€ LOCAL STATE (mirror of Firebase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  rooms: [
    { queue:[], currentServing:0, counter:0 },
    { queue:[], currentServing:0, counter:0 },
    { queue:[], currentServing:0, counter:0 },
  ]
};

let adminUnlocked = false;
let activeAdminRoom = 0;
let activeQueueRoom = 0;
let currentTab = 'book';

// â”€â”€â”€ LOADING UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  document.getElementById('loading-bar').style.width = on ? '70%' : '0%';
}

// â”€â”€â”€ CONNECTION STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const connRef = ref(db, '.info/connected');
onValue(connRef, snap => {
  const el = document.getElementById('conn-status');
  if(snap.val()) {
    el.textContent = 'â— ONLINE'; el.className = 'conn-status conn-online';
  } else {
    el.textContent = 'â—‹ OFFLINE'; el.className = 'conn-status conn-offline';
  }
});

// â”€â”€â”€ TODAY KEY (for daily reset) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function dbPath() { return `filmnoir/${todayKey()}`; }

// â”€â”€â”€ REALTIME LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dataRef = () => ref(db, dbPath());

function startListening() {
  onValue(dataRef(), snap => {
    const data = snap.val();
    if(!data) {
      // No data for today yet â€” init
      state = {
        rooms: [
          { queue:[], currentServing:0, counter:0 },
          { queue:[], currentServing:0, counter:0 },
          { queue:[], currentServing:0, counter:0 },
        ]
      };
    } else {
      // Merge from Firebase
      state.rooms = ROOMS.map((r, i) => {
        const rd = data[r.key] || {};
        return {
          queue: rd.queue ? Object.values(rd.queue).sort((a,b) => a.order - b.order) : [],
          currentServing: rd.currentServing || 0,
          counter: rd.counter || 0,
        };
      });
    }
    // Re-render current view
    rerenderCurrentTab();
  });
}

function rerenderCurrentTab() {
  if(currentTab === 'queue') { renderQueueOverview(); renderQueueRoom(activeQueueRoom); }
  if(currentTab === 'admin') { renderAdminOverview(); renderAdminRoom(activeAdminRoom); }
}

// â”€â”€â”€ FIREBASE WRITE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function roomRef(ri) { return ref(db, `${dbPath()}/${ROOMS[ri].key}`); }
function queueRef(ri) { return ref(db, `${dbPath()}/${ROOMS[ri].key}/queue`); }

async function writeRoom(ri) {
  const r = state.rooms[ri];
  // Convert queue array â†’ object keyed by id
  const queueObj = {};
  r.queue.forEach((entry, idx) => {
    queueObj[entry.id] = { ...entry, order: idx };
  });
  await set(roomRef(ri), {
    currentServing: r.currentServing,
    counter: r.counter,
    queue: queueObj
  });
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showAdminModal = function() {
  document.getElementById('admin-modal').style.display='flex';
  document.getElementById('modal-pw-input').value='';
  document.getElementById('modal-pw-error').style.display='none';
  setTimeout(() => document.getElementById('modal-pw-input').focus(), 100);
};
window.closeAdminModal = function() {
  document.getElementById('admin-modal').style.display='none';
};
window.submitAdminPw = function() {
  const pw = document.getElementById('modal-pw-input').value;
  if(pw === 'Filmnoir2610') {
    adminUnlocked = true;
    closeAdminModal();
    doSwitchTab('admin');
  } else {
    document.getElementById('modal-pw-error').style.display='block';
    document.getElementById('modal-pw-input').value='';
    document.getElementById('modal-pw-input').focus();
  }
};

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchTab = function(tab) {
  if(tab === 'admin' && !adminUnlocked) { showAdminModal(); return; }
  doSwitchTab(tab);
};

function doSwitchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.style.display='none');
  document.getElementById('tab-'+tab).style.display='block';
  document.querySelectorAll('nav.tabs button').forEach(btn => btn.classList.remove('active'));
  ['book','check','queue','admin'].forEach((t,i) => {
    if(t===tab) document.querySelectorAll('nav.tabs button')[i].classList.add('active');
  });
  if(tab==='queue') { renderQueueOverview(); renderQueueRoom(activeQueueRoom); }
  if(tab==='admin') { renderAdminOverview(); renderAdminRoom(activeAdminRoom); }
  if(tab==='check') document.getElementById('check-result').style.display='none';
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function roomDisplayName(key) {
  const r = ROOMS.find(r => r.key === key);
  return r ? `${r.label} â€“ ${r.name}` : key;
}

function getWaitCount(ri, num) {
  return state.rooms[ri].queue.findIndex(q => q.num === num);
}

function notifMsg(waitCount) {
  if(waitCount === 0) return '<div class="notif">ğŸ¬ Äáº¿n lÆ°á»£t báº¡n rá»“i! Vui lÃ²ng vÃ o phÃ²ng chá»¥p nhÃ©.</div>';
  const minutes = waitCount * 6;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  const timeStr = hours > 0 ? `${hours} tiáº¿ng ${mins} phÃºt` : `${mins} phÃºt`;
  if(waitCount <= 3) return `<div class="notif">â³ CÃ²n ${waitCount} ngÆ°á»i phÃ­a trÆ°á»›c, thá»i gian chá» khoáº£ng ${timeStr}. Báº¡n nÃªn cÃ³ máº·t sáºµn nhÃ©!</div>`;
  return `<div class="notif">â³ CÃ²n ${waitCount} ngÆ°á»i phÃ­a trÆ°á»›c, thá»i gian chá» khoáº£ng ${timeStr}.</div>`;
}

// â”€â”€â”€ BOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.bookQueue = async function() {
  const name = document.getElementById('inp-name').value.trim();
  const phone = document.getElementById('inp-phone').value.trim();
  const roomKey = document.getElementById('inp-room').value;
  const msgEl = document.getElementById('msg-book');
  msgEl.innerHTML='';

  if(!name) { msgEl.innerHTML='<div class="msg msg-error">Vui lÃ²ng nháº­p há» tÃªn.</div>'; return; }
  if(!phone||phone.length<8) { msgEl.innerHTML='<div class="msg msg-error">Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i há»£p lá»‡.</div>'; return; }
  if(!roomKey) { msgEl.innerHTML='<div class="msg msg-error">Vui lÃ²ng chá»n phÃ²ng chá»¥p.</div>'; return; }

  // Check duplicate across all rooms
  const allEntries = state.rooms.flatMap(r => r.queue);
  if(allEntries.find(q => q.phone === phone)) {
    msgEl.innerHTML='<div class="msg msg-error">Sá»‘ Ä‘iá»‡n thoáº¡i nÃ y Ä‘Ã£ cÃ³ trong hÃ ng chá».</div>'; return;
  }

  const btn = document.getElementById('btn-book');
  btn.disabled = true; btn.textContent = 'Äang xá»­ lÃ½...';
  setLoading(true);

  try {
    const ri = ROOMS.findIndex(r => r.key === roomKey);
    // Use transaction to safely increment counter
    const counterRef = ref(db, `${dbPath()}/${roomKey}/counter`);
    let newNum;
    await runTransaction(counterRef, current => { newNum = (current || 0) + 1; return newNum; });

    const id = `e${Date.now()}`;
    const entry = {
      id, num: newNum, name, phone,
      time: new Date().toLocaleTimeString('vi-VN'),
      order: Date.now()
    };

    await set(ref(db, `${dbPath()}/${roomKey}/queue/${id}`), entry);

    // Show ticket
    document.getElementById('form-card').style.display='none';
    document.getElementById('ticket-wrap').style.display='block';
    document.getElementById('ticket-num').textContent = String(newNum).padStart(2,'0');
    document.getElementById('ticket-name').textContent = name;
    document.getElementById('ticket-room').textContent = roomDisplayName(roomKey);

    // Wait count from local state (approximate)
    const waitCount = state.rooms[ri].queue.length; // will be at the end
    document.getElementById('ticket-notif').innerHTML = notifMsg(waitCount);

    // QR
    const canvas = document.getElementById('qr-canvas');
    const img = new Image();
    img.crossOrigin='anonymous';
    img.onload = () => { canvas.getContext('2d').drawImage(img,0,0,140,140); };
    img.src = QR_API(`filmnoir://check?phone=${phone}`);

  } catch(e) {
    msgEl.innerHTML='<div class="msg msg-error">Lá»—i káº¿t ná»‘i. Vui lÃ²ng thá»­ láº¡i.</div>';
  } finally {
    btn.disabled=false; btn.textContent='âœ¦ Láº¥y Sá»‘ Thá»© Tá»±';
    setLoading(false);
  }
};

window.resetForm = function() {
  document.getElementById('form-card').style.display='block';
  document.getElementById('ticket-wrap').style.display='none';
  ['inp-name','inp-phone'].forEach(id => document.getElementById(id).value='');
  document.getElementById('inp-room').value='';
  document.getElementById('msg-book').innerHTML='';
};

// â”€â”€â”€ CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.checkQueue = function() {
  const phone = document.getElementById('chk-phone').value.trim();
  const msgEl = document.getElementById('msg-check');
  const result = document.getElementById('check-result');
  msgEl.innerHTML=''; result.style.display='none';

  if(!phone) { msgEl.innerHTML='<div class="msg msg-error">Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i Ä‘á»ƒ tra cá»©u.</div>'; return; }

  let foundEntry=null, foundRi=-1;
  state.rooms.forEach((room,ri) => {
    const e = room.queue.find(q => q.phone===phone);
    if(e) { foundEntry=e; foundRi=ri; }
  });

  if(!foundEntry) { msgEl.innerHTML='<div class="msg msg-error">KhÃ´ng tÃ¬m tháº¥y sá»‘ Ä‘iá»‡n thoáº¡i nÃ y trong hÃ ng chá».</div>'; return; }

  const room = state.rooms[foundRi];
  const waitCount = getWaitCount(foundRi, foundEntry.num);

  document.getElementById('chk-num').textContent = String(foundEntry.num).padStart(2,'0');
  document.getElementById('chk-name').textContent = foundEntry.name;
  document.getElementById('chk-room').textContent = roomDisplayName(ROOMS[foundRi].key);
  document.getElementById('chk-current').textContent = room.currentServing ? String(room.currentServing).padStart(2,'0') : 'â€“';
  document.getElementById('chk-wait').textContent = waitCount;
  document.getElementById('chk-notif').innerHTML = notifMsg(waitCount);
  result.style.display='block';
};

window.cancelFromCheck = async function() {
  const phone = document.getElementById('chk-phone').value.trim();
  for(let ri=0; ri<ROOMS.length; ri++) {
    const entry = state.rooms[ri].queue.find(q => q.phone===phone);
    if(entry) {
      setLoading(true);
      await remove(ref(db, `${dbPath()}/${ROOMS[ri].key}/queue/${entry.id}`));
      setLoading(false);
      document.getElementById('check-result').style.display='none';
      document.getElementById('msg-check').innerHTML='<div class="msg msg-success">LÆ°á»£t cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c huá»· thÃ nh cÃ´ng.</div>';
      return;
    }
  }
};

// â”€â”€â”€ QUEUE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQueueOverview() {
  document.getElementById('queue-overview').innerHTML = ROOMS.map((r,i) => {
    const room = state.rooms[i];
    return `<div class="room-overview-card ${i===activeQueueRoom?'selected':''}" onclick="switchRoomQueue(${i})">
      <div class="room-label">${r.label}</div>
      <div class="room-name">${r.name}</div>
      <div class="room-count">${room.queue.length}</div>
      <div class="room-sub">Ä‘ang chá»</div>
      <div class="room-serving">Äang phá»¥c vá»¥: <strong style="color:var(--wine)">${room.currentServing ? String(room.currentServing).padStart(2,'0') : 'â€“'}</strong></div>
    </div>`;
  }).join('');
}

window.switchRoomQueue = function(ri) {
  activeQueueRoom=ri;
  document.querySelectorAll('#queue-room-tabs button').forEach((btn,i) => btn.classList.toggle('active',i===ri));
  renderQueueOverview(); renderQueueRoom(ri);
};

function renderQueueRoom(ri) {
  const room = state.rooms[ri];
  const el = document.getElementById('queue-room-detail');
  if(!room.queue.length) {
    el.innerHTML=`<div class="card fade-in"><p style="color:var(--gray);font-style:italic;">PhÃ²ng ${ROOMS[ri].name} chÆ°a cÃ³ ai trong hÃ ng chá».</p></div>`;
    return;
  }
  el.innerHTML=`<div class="card fade-in">${room.queue.map((entry,idx) => {
    let cls='', badge='';
    if(idx===0){cls='current';badge='<span class="badge badge-now">Tiáº¿p Theo</span>';}
    else if(idx<=2){cls='almost';badge='<span class="badge badge-soon">Sáº¯p Tá»›i</span>';}
    return `<div class="queue-item ${cls}">
      <div class="q-num">${String(entry.num).padStart(2,'0')}</div>
      <div class="q-info">
        <div class="q-name">${entry.name}</div>
        <div class="q-detail">${entry.phone} &nbsp;Â·&nbsp; ${entry.time}</div>
      </div>
      ${badge}
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€â”€ ADMIN TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdminOverview() {
  document.getElementById('admin-overview').innerHTML = ROOMS.map((r,i) => {
    const room = state.rooms[i];
    return `<div class="room-overview-card ${i===activeAdminRoom?'selected':''}" onclick="switchRoomAdmin(${i})">
      <div class="room-label">${r.label}</div>
      <div class="room-name">${r.name}</div>
      <div class="room-count">${room.queue.length}</div>
      <div class="room-sub">Ä‘ang chá»</div>
      <div class="room-serving">Phá»¥c vá»¥: <strong style="color:var(--wine)">${room.currentServing ? String(room.currentServing).padStart(2,'0') : 'â€“'}</strong> &nbsp;|&nbsp; Tá»•ng: <strong style="color:var(--wine)">${room.counter}</strong></div>
    </div>`;
  }).join('');
}

window.switchRoomAdmin = function(ri) {
  activeAdminRoom=ri;
  document.querySelectorAll('#admin-room-tabs button').forEach((btn,i) => btn.classList.toggle('active',i===ri));
  document.getElementById('msg-admin').innerHTML='';
  renderAdminOverview(); renderAdminRoom(ri);
};

function renderAdminRoom(ri) {
  const r = ROOMS[ri];
  document.getElementById('admin-room-title').textContent=`${r.label} â€“ ${r.name}`;
  const room = state.rooms[ri];
  const listEl = document.getElementById('admin-queue-list');
  if(!room.queue.length) {
    listEl.innerHTML='<p style="color:var(--gray);font-style:italic;">HÃ ng chá» phÃ²ng nÃ y Ä‘ang trá»‘ng.</p>';
    return;
  }
  listEl.innerHTML = room.queue.map((entry,idx) => `
    <div class="admin-queue-item">
      <div class="q-num">${String(entry.num).padStart(2,'0')}</div>
      <div class="q-info" style="flex:1;">
        <div class="q-name">${entry.name}</div>
        <div class="q-detail">${entry.phone} Â· ${entry.time}</div>
      </div>
      ${idx===0?`<button class="btn-serve" onclick="serveNext()">Phá»¥c vá»¥ â†’</button>`:''}
      <button class="btn-remove" onclick="cancelEntry(${ri},'${entry.id}',${entry.num})">Huá»·</button>
    </div>
  `).join('');
}

window.serveNext = async function() {
  const room = state.rooms[activeAdminRoom];
  if(!room.queue.length) {
    document.getElementById('msg-admin').innerHTML='<div class="msg msg-error">HÃ ng chá» phÃ²ng nÃ y Ä‘ang trá»‘ng.</div>'; return;
  }
  const served = room.queue[0];
  setLoading(true);
  try {
    await update(roomRef(activeAdminRoom), { currentServing: served.num });
    await remove(ref(db, `${dbPath()}/${ROOMS[activeAdminRoom].key}/queue/${served.id}`));
    document.getElementById('msg-admin').innerHTML=`<div class="msg msg-success">Äang phá»¥c vá»¥ sá»‘ <strong>${String(served.num).padStart(2,'0')}</strong> â€“ ${served.name}</div>`;
  } catch(e) {
    document.getElementById('msg-admin').innerHTML='<div class="msg msg-error">Lá»—i. Vui lÃ²ng thá»­ láº¡i.</div>';
  }
  setLoading(false);
};

window.cancelEntry = async function(ri, id, num) {
  setLoading(true);
  await remove(ref(db, `${dbPath()}/${ROOMS[ri].key}/queue/${id}`));
  setLoading(false);
};

window.resetRoom = async function() {
  const r = ROOMS[activeAdminRoom];
  if(!confirm(`Reset toÃ n bá»™ hÃ ng chá» ${r.label} â€“ ${r.name}?`)) return;
  setLoading(true);
  await set(roomRef(activeAdminRoom), { queue:{}, currentServing:0, counter:0 });
  setLoading(false);
  document.getElementById('msg-admin').innerHTML=`<div class="msg msg-success">ÄÃ£ reset hÃ ng chá» ${r.label}.</div>`;
};

// â”€â”€â”€ MIDNIGHT AUTO RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleMidnightReset() {
  const now = new Date();
  const midnight = new Date(now);
  midnight.setHours(24,0,5,0); // 00:00:05 next day
  const ms = midnight - now;
  setTimeout(() => {
    // Old day's data stays under old key automatically
    // New day starts fresh since todayKey() changes
    rerenderCurrentTab();
    scheduleMidnightReset();
  }, ms);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startListening();
scheduleMidnightReset();

</script>

</body>
</html>
